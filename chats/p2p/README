// UTF-8.ru_RU, 0a

Многопользовательский чат типа точка-точка.

---- Словарь.
Клиент = собеседник.
Сервер = справочник адресов собеседников.
Справочник адресов собеседников = набор строк, содержащих название собеседника,
                                  IP-адрес, порт.

---- Организация.
--- Сервер.
Сервер выступает в роли не более, чем справочника адресов собеседников,
раздавая его всем подключившимся и поддерживая его актуальность у клиентов
при необходимости - подключении нового клиента, отключении клиента.
Отключение клиента будет определено позже.
Сервер использует два канала данных. Первый - для установления соединения с
клиентом и его регистрации в чате. Второй - для оповещение сервера о прекращении
или продолжении связи со стороны клиента и ожидания клиентами поправок к
справочнику.
Первый канал - TCP.
Второй канал - UDP.
Подтверждение о продолжении связи сервер ожидает от каждого клиента 1 раз в
ping_interval секунд. При отсутствии очередного подтверждения клиент считается
отключившимся.
Между запусками справочник хранится в БД SQLite 3.x
-- Структура записей в БД.
Таблица clients:
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    nickname CHAR(24),
    keyword CHAR(24),
    host TEXT,
    port INTEGER,
    UNIQUE(nickname)

--- Клиент.
Клиент при запуске подключается к серверу, представляется, запрашивает
справочник собеседников, сообщает о намерении продолжать беседу с кем-нибудь
и разрывает соединение. После этого, используется второй канал данных.
В том числе и для подтверждения того, что клиент все еще на связи.

Подключение клиента к серверу = установка TCP-соединение, представление.
Представление = сообщение серверу своих реквизитов (название в чате),
                получение кодового слова.
Разрыв соединения = прекращение TCP-соединения.
Отключение клиента от сервера = соответствующее оповещение сервера клиентом.

--- Подробности.
Ключевые слова:
    nickname - название клиента в чате.
    keyword - кодовое слово, выделяемое сервером клиенту.
    ip - адрес собеседника.
    port - порт собеседника.
    cl_cnt - кол-во собеседников.
    len - длина сообщения в байтах во втором канале.
    (a)/k - повторение группы 'a' 'k' раз через пробел
            (в соответствии с контекстом).

Что передается (направление = [к-с = клиент-сервер, с-к = сервер-клиент])

-- Первый канал:
Представление (к-с):
CONNECT nickname

Выдача кодового слова (с-к):
KEYWORD keyword

Запрос справочника (к-с):
REFERENCE?

Пересылка справочника (с-к):
REFERENCE cl_cnt (nickname ip port)/cl_cnt

Намерение продолжать беседу (смена канала с первого на второй) (к-с):
CHANNEL_SWITCH

-- Второй канал:
Добавленые строки в справочнике (с-к):
keyword len REF_ADD cl_cnt (nickname ip port)/cl_cnt

Убраные строки в справочнике (c-к):
keyword len REF_DEL cl_cnt (nickname)/cl_cnt

Отключение (к-с):
keyword len QUIT nickname

Подтверждение наличия клиента на связи (к-с)
keyword len PING nickname
